name: End-to-End Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  quick-test:
    name: Quick Test (No Docker)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Run quick test
      run: ./scripts/test-hatch.sh
    
    - name: Run auto-detect test
      run: ./scripts/test-autodetect.sh
    
    - name: Check instances directory
      run: |
        echo "Instances created during test:"
        ls -la instances/ || echo "No instances directory"

  e2e-test:
    name: End-to-End Test
    runs-on: ubuntu-latest
    # Only run if we have API keys configured (optional)
    # Remove this if you want to test without API keys
    # if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Run end-to-end test
      run: ./scripts/e2e-test.sh
      env:
        # Optional: Set these as repository secrets for full testing
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    
    - name: Show Docker logs on failure
      if: failure()
      run: |
        echo "=== Docker containers ==="
        docker ps -a || true
        echo "=== Docker images ==="
        docker images || true
        echo "=== Instance directories ==="
        ls -la instances/ || true
        echo "=== Test instance files ==="
        find instances/ -type f 2>/dev/null || true

  # Test on macOS with Docker Desktop (optional, remove if not needed)
  e2e-test-macos:
    name: End-to-End Test (macOS)
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Docker
      run: |
        brew install docker docker-compose
        colima start
    
    - name: Run end-to-end test
      run: ./scripts/e2e-test.sh
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
